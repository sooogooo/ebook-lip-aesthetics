<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€åŒ–ARæµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
        }

        #video {
            width: 100vw;
            height: 100vh;
            object-fit: cover;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            gap: 10px;
        }

        button {
            background: rgba(52, 152, 219, 0.8);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }

        button:hover {
            background: rgba(41, 128, 185, 0.9);
        }

        .status {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .error {
            background: rgba(231, 76, 60, 0.9);
        }

        .success {
            background: rgba(46, 204, 113, 0.9);
        }

        .ar-marker {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #e74c3c;
            border: 2px solid white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);
        }

        .face-outline {
            position: absolute;
            border: 2px solid #3498db;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.5);
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            text-align: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <div>æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...</div>
    </div>

    <video id="video" autoplay playsinline></video>

    <div class="overlay" id="overlay"></div>

    <div class="status" id="status">
        <div>ğŸ“± ç§»åŠ¨ARå”‡éƒ¨åˆ†æç³»ç»Ÿ</div>
        <div id="status-text">æ­£åœ¨åˆå§‹åŒ–...</div>
    </div>

    <div class="controls">
        <button onclick="startCamera()">ğŸ¥ å¯åŠ¨æ‘„åƒå¤´</button>
        <button onclick="toggleAnalysis()">ğŸ” åˆ‡æ¢åˆ†æ</button>
        <button onclick="captureFrame()">ğŸ“¸ æˆªå›¾</button>
        <button onclick="toggleCamera()">ğŸ”„ åˆ‡æ¢æ‘„åƒå¤´</button>
    </div>

    <script>
        let video, stream, isAnalyzing = false, currentCamera = 'user';
        let faceDetectionInterval;

        const config = {
            video: {
                facingMode: currentCamera,
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };

        async function startCamera() {
            try {
                updateStatus('æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´æƒé™...', 'info');

                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }

                stream = await navigator.mediaDevices.getUserMedia(config);
                video = document.getElementById('video');
                video.srcObject = stream;

                video.onloadedmetadata = () => {
                    video.play();
                    document.getElementById('loading').style.display = 'none';
                    updateStatus('æ‘„åƒå¤´å¯åŠ¨æˆåŠŸï¼ç‚¹å‡»"åˆ‡æ¢åˆ†æ"å¼€å§‹é¢éƒ¨æ£€æµ‹', 'success');
                };

            } catch (error) {
                handleCameraError(error);
            }
        }

        function handleCameraError(error) {
            document.getElementById('loading').style.display = 'none';
            let message = 'æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: ';

            switch (error.name) {
                case 'NotAllowedError':
                    message += 'ç”¨æˆ·æ‹’ç»äº†æ‘„åƒå¤´æƒé™';
                    break;
                case 'NotFoundError':
                    message += 'æœªæ‰¾åˆ°æ‘„åƒå¤´è®¾å¤‡';
                    break;
                case 'NotSupportedError':
                    message += 'æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´åŠŸèƒ½';
                    break;
                default:
                    message += error.message;
            }

            updateStatus(message, 'error');
        }

        function toggleAnalysis() {
            isAnalyzing = !isAnalyzing;

            if (isAnalyzing) {
                startFaceDetection();
                updateStatus('AIé¢éƒ¨åˆ†æå·²å¯åŠ¨ - æ£€æµ‹å”‡éƒ¨ç‰¹å¾ä¸­...', 'success');
            } else {
                stopFaceDetection();
                updateStatus('é¢éƒ¨åˆ†æå·²åœæ­¢', 'info');
            }
        }

        function startFaceDetection() {
            const overlay = document.getElementById('overlay');
            overlay.innerHTML = '';

            // æ¨¡æ‹Ÿé¢éƒ¨æ£€æµ‹
            faceDetectionInterval = setInterval(() => {
                if (!isAnalyzing) return;

                // æ¨¡æ‹Ÿæ£€æµ‹åˆ°çš„é¢éƒ¨
                simulateFaceDetection();
            }, 100);
        }

        function simulateFaceDetection() {
            const overlay = document.getElementById('overlay');
            overlay.innerHTML = '';

            // æ¨¡æ‹Ÿé¢éƒ¨è½®å»“
            const faceOutline = document.createElement('div');
            faceOutline.className = 'face-outline';

            // éšæœºä½ç½®æ¨¡æ‹Ÿé¢éƒ¨æ£€æµ‹
            const centerX = window.innerWidth * (0.3 + Math.random() * 0.4);
            const centerY = window.innerHeight * (0.2 + Math.random() * 0.4);
            const size = 200 + Math.random() * 100;

            faceOutline.style.left = (centerX - size/2) + 'px';
            faceOutline.style.top = (centerY - size/2) + 'px';
            faceOutline.style.width = size + 'px';
            faceOutline.style.height = size + 'px';

            overlay.appendChild(faceOutline);

            // æ¨¡æ‹Ÿå”‡éƒ¨ç‰¹å¾ç‚¹
            addLipMarkers(centerX, centerY + size * 0.2);
        }

        function addLipMarkers(centerX, centerY) {
            const overlay = document.getElementById('overlay');

            // ä¸Šå”‡ç‰¹å¾ç‚¹
            const upperLipPoints = [
                { x: centerX - 30, y: centerY - 10 },
                { x: centerX, y: centerY - 15 },
                { x: centerX + 30, y: centerY - 10 }
            ];

            // ä¸‹å”‡ç‰¹å¾ç‚¹
            const lowerLipPoints = [
                { x: centerX - 25, y: centerY + 10 },
                { x: centerX, y: centerY + 15 },
                { x: centerX + 25, y: centerY + 10 }
            ];

            [...upperLipPoints, ...lowerLipPoints].forEach((point, index) => {
                const marker = document.createElement('div');
                marker.className = 'ar-marker';
                marker.style.left = point.x + 'px';
                marker.style.top = point.y + 'px';
                marker.title = `ç‰¹å¾ç‚¹ ${index + 1}`;
                overlay.appendChild(marker);
            });
        }

        function stopFaceDetection() {
            if (faceDetectionInterval) {
                clearInterval(faceDetectionInterval);
            }
            document.getElementById('overlay').innerHTML = '';
        }

        function captureFrame() {
            if (!video || !video.videoWidth) {
                updateStatus('è¯·å…ˆå¯åŠ¨æ‘„åƒå¤´', 'error');
                return;
            }

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            canvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `lip_analysis_${Date.now()}.png`;
                a.click();
                URL.revokeObjectURL(url);
            });

            updateStatus('æˆªå›¾å·²ä¿å­˜', 'success');
        }

        function toggleCamera() {
            currentCamera = currentCamera === 'user' ? 'environment' : 'user';
            config.video.facingMode = currentCamera;

            updateStatus(`åˆ‡æ¢åˆ°${currentCamera === 'user' ? 'å‰' : 'å'}ç½®æ‘„åƒå¤´`, 'info');
            startCamera();
        }

        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            document.getElementById('status-text').textContent = message;

            statusElement.className = 'status';
            if (type === 'error') statusElement.classList.add('error');
            if (type === 'success') statusElement.classList.add('success');
        }

        // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
        function checkSupport() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                updateStatus('æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´åŠŸèƒ½', 'error');
                return false;
            }
            return true;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥æ”¯æŒå¹¶æç¤º
        window.onload = function() {
            if (checkSupport()) {
                updateStatus('ç‚¹å‡»"å¯åŠ¨æ‘„åƒå¤´"å¼€å§‹ARä½“éªŒ', 'info');
                document.getElementById('loading').style.display = 'none';
            }
        };

        // å¤„ç†é¡µé¢å¯è§æ€§å˜åŒ–
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && isAnalyzing) {
                stopFaceDetection();
            }
        });
    </script>
</body>
</html>