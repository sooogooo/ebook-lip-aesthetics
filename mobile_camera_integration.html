<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>移动相机集成 - 绛唇解语花</title>
    <meta name="description" content="移动设备相机集成，支持AR功能、实时分析和拍照功能">

    <!-- CSS Dependencies -->
    <link rel="stylesheet" href="mobile_optimizations.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
            position: relative;
            user-select: none;
            -webkit-user-select: none;
        }

        /* Camera Container */
        .camera-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: flex;
            flex-direction: column;
            z-index: 1;
        }

        /* Video Stream */
        .camera-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
        }

        /* Canvas for AR Overlay */
        .ar-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        /* Safe Area Container */
        .safe-area-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            pointer-events: none;
            z-index: 20;
        }

        /* Top Controls */
        .top-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: auto;
            z-index: 30;
        }

        /* Bottom Controls */
        .bottom-controls {
            position: absolute;
            bottom: 40px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            pointer-events: auto;
            z-index: 30;
        }

        /* Control Buttons */
        .control-btn {
            width: 56px;
            height: 56px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 20px;
        }

        .control-btn:active {
            transform: scale(0.9);
            background: rgba(255, 255, 255, 0.4);
        }

        .control-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Capture Button */
        .capture-btn {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.9);
            border: 4px solid white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            position: relative;
        }

        .capture-btn:active {
            transform: scale(0.95);
        }

        .capture-btn::before {
            content: '';
            width: 60px;
            height: 60px;
            background: #d4af37;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .capture-btn.recording::before {
            border-radius: 8px;
            background: #ff4444;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Mode Selector */
        .mode-selector {
            position: absolute;
            bottom: 140px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 25px;
            padding: 4px;
            gap: 4px;
            pointer-events: auto;
        }

        .mode-btn {
            padding: 8px 16px;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border: none;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .mode-btn.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* AR Overlay Elements */
        .ar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 15;
        }

        .ar-marker {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 2px solid #d4af37;
            border-radius: 50%;
            background: rgba(212, 175, 55, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: arPulse 2s infinite;
            font-size: 12px;
            color: white;
        }

        @keyframes arPulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
        }

        /* Analysis Panel */
        .analysis-panel {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 16px;
            min-width: 200px;
            pointer-events: auto;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .analysis-panel.visible {
            opacity: 1;
        }

        .analysis-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .analysis-value {
            color: #d4af37;
            font-weight: 600;
        }

        /* Loading Indicator */
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            color: white;
            z-index: 40;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #d4af37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error Message */
        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 68, 68, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            max-width: 300px;
            z-index: 50;
        }

        /* Voice Control Indicator */
        .voice-indicator {
            position: absolute;
            top: 100px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: rgba(212, 175, 55, 0.2);
            border: 2px solid #d4af37;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: auto;
        }

        .voice-indicator.active {
            opacity: 1;
            animation: voicePulse 1s infinite;
        }

        @keyframes voicePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Media Queries for Different Screen Sizes */
        @media screen and (max-width: 375px) {
            .bottom-controls {
                gap: 20px;
            }

            .capture-btn {
                width: 70px;
                height: 70px;
            }

            .capture-btn::before {
                width: 50px;
                height: 50px;
            }
        }

        @media screen and (min-height: 812px) {
            .bottom-controls {
                bottom: 60px;
            }

            .mode-selector {
                bottom: 160px;
            }
        }

        /* Landscape Orientation */
        @media screen and (orientation: landscape) {
            .top-controls {
                left: env(safe-area-inset-left, 20px);
                right: env(safe-area-inset-right, 20px);
            }

            .bottom-controls {
                left: env(safe-area-inset-left, 20px);
                right: env(safe-area-inset-right, 20px);
            }

            .analysis-panel {
                left: calc(env(safe-area-inset-left, 0px) + 20px);
            }
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        @media (prefers-contrast: high) {
            .control-btn {
                background: rgba(255, 255, 255, 0.9);
                color: #000;
            }

            .ar-marker {
                border-color: #fff;
                background: rgba(255, 255, 255, 0.3);
            }
        }
    </style>
</head>
<body>
    <!-- Camera Container -->
    <div class="camera-container" id="cameraContainer">
        <!-- Video Stream -->
        <video class="camera-video" id="cameraVideo" autoplay muted playsinline></video>

        <!-- AR Canvas Overlay -->
        <canvas class="ar-canvas" id="arCanvas"></canvas>

        <!-- AR Overlay -->
        <div class="ar-overlay" id="arOverlay"></div>

        <!-- Safe Area Container -->
        <div class="safe-area-container">
            <!-- Top Controls -->
            <div class="top-controls">
                <button class="control-btn" id="closeBtn" title="关闭">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>

                <button class="control-btn" id="flashBtn" title="闪光灯">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M7 2v11h3v9l7-12h-4l4-8z"/>
                    </svg>
                </button>

                <button class="control-btn" id="switchCameraBtn" title="切换摄像头">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 4h-3.17L15 2H9L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 11.5V13H9v2.5L5.5 12 9 8.5V11h6V8.5L18.5 12 15 15.5z"/>
                    </svg>
                </button>

                <button class="control-btn" id="settingsBtn" title="设置">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                    </svg>
                </button>
            </div>

            <!-- Voice Control Indicator -->
            <div class="voice-indicator" id="voiceIndicator">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
                </svg>
            </div>

            <!-- Analysis Panel -->
            <div class="analysis-panel" id="analysisPanel">
                <div class="analysis-item">
                    <span>唇部对称性</span>
                    <span class="analysis-value" id="symmetryValue">--</span>
                </div>
                <div class="analysis-item">
                    <span>上下唇比例</span>
                    <span class="analysis-value" id="ratioValue">--</span>
                </div>
                <div class="analysis-item">
                    <span>饱满度</span>
                    <span class="analysis-value" id="fullnessValue">--</span>
                </div>
                <div class="analysis-item">
                    <span>颜色均匀度</span>
                    <span class="analysis-value" id="colorValue">--</span>
                </div>
            </div>

            <!-- Mode Selector -->
            <div class="mode-selector">
                <button class="mode-btn active" data-mode="photo">拍照</button>
                <button class="mode-btn" data-mode="video">录像</button>
                <button class="mode-btn" data-mode="ar">AR</button>
                <button class="mode-btn" data-mode="analysis">分析</button>
            </div>

            <!-- Bottom Controls -->
            <div class="bottom-controls">
                <button class="control-btn" id="galleryBtn" title="相册">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M22 16V4c0-1.1-.9-2-2-2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2zm-11-4l2.03 2.71L16 11l4 5H8l3-4zM2 6v14c0 1.1.9 2 2 2h14v-2H4V6H2z"/>
                    </svg>
                </button>

                <button class="capture-btn" id="captureBtn"></button>

                <button class="control-btn" id="voiceBtn" title="语音控制">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="loading-indicator" id="loadingIndicator">
            <div class="loading-spinner"></div>
            <div>正在启动相机...</div>
        </div>

        <!-- Error Message -->
        <div class="error-message" id="errorMessage" style="display: none;">
            <h3>相机启动失败</h3>
            <p>请检查相机权限设置并重试</p>
            <button class="touch-button" onclick="location.reload()" style="margin-top: 12px;">重试</button>
        </div>
    </div>

    <!-- JavaScript Dependencies -->
    <script src="mobile_gestures.js"></script>

    <script>
        /**
         * Mobile Camera Integration System
         * Supports camera access, AR features, real-time analysis, and voice control
         */

        class MobileCameraSystem {
            constructor() {
                this.video = document.getElementById('cameraVideo');
                this.canvas = document.getElementById('arCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.stream = null;
                this.currentMode = 'photo';
                this.isRecording = false;
                this.mediaRecorder = null;
                this.facingMode = 'user'; // 'user' for front camera, 'environment' for back
                this.flashEnabled = false;
                this.analysisActive = false;
                this.voiceActive = false;

                // AR and Analysis
                this.faceDetector = null;
                this.landmarks = [];
                this.analysisResults = {};

                // Voice Recognition
                this.speechRecognition = null;
                this.gestureHandler = null;

                this.init();
            }

            async init() {
                try {
                    await this.setupCamera();
                    this.setupEventListeners();
                    this.setupGestureHandling();
                    this.setupVoiceControl();
                    this.setupFaceDetection();
                    this.resizeCanvas();
                    this.hideLoading();
                } catch (error) {
                    console.error('Camera initialization failed:', error);
                    this.showError(error);
                }
            }

            async setupCamera() {
                try {
                    const constraints = {
                        video: {
                            facingMode: this.facingMode,
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: this.currentMode === 'video'
                    };

                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = this.stream;

                    this.video.addEventListener('loadedmetadata', () => {
                        this.resizeCanvas();
                    });

                } catch (error) {
                    throw new Error('无法访问相机: ' + error.message);
                }
            }

            setupEventListeners() {
                // Close button
                document.getElementById('closeBtn').addEventListener('click', () => {
                    this.closeCamera();
                });

                // Flash toggle
                document.getElementById('flashBtn').addEventListener('click', () => {
                    this.toggleFlash();
                });

                // Switch camera
                document.getElementById('switchCameraBtn').addEventListener('click', () => {
                    this.switchCamera();
                });

                // Capture button
                document.getElementById('captureBtn').addEventListener('click', () => {
                    this.handleCapture();
                });

                // Gallery button
                document.getElementById('galleryBtn').addEventListener('click', () => {
                    this.openGallery();
                });

                // Voice control button
                document.getElementById('voiceBtn').addEventListener('click', () => {
                    this.toggleVoiceControl();
                });

                // Mode selector
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.setMode(e.target.dataset.mode);
                    });
                });

                // Resize event
                window.addEventListener('resize', () => {
                    this.resizeCanvas();
                });

                // Orientation change
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => this.resizeCanvas(), 100);
                });
            }

            setupGestureHandling() {
                this.gestureHandler = new MobileGestureHandler(this.video, {
                    enablePinchZoom: true,
                    enableSwipe: true,
                    enableDrag: false,
                    enableVoiceControl: true
                });

                this.gestureHandler.on('pinch', ({ scale }) => {
                    if (this.stream) {
                        const track = this.stream.getVideoTracks()[0];
                        const capabilities = track.getCapabilities();

                        if (capabilities.zoom) {
                            const settings = track.getSettings();
                            const newZoom = Math.max(
                                capabilities.zoom.min,
                                Math.min(capabilities.zoom.max, settings.zoom * scale)
                            );

                            track.applyConstraints({
                                advanced: [{ zoom: newZoom }]
                            });
                        }
                    }
                });

                this.gestureHandler.on('swipe', ({ direction }) => {
                    switch (direction) {
                        case 'up':
                            this.setMode('ar');
                            break;
                        case 'down':
                            this.setMode('photo');
                            break;
                        case 'left':
                            this.nextMode();
                            break;
                        case 'right':
                            this.previousMode();
                            break;
                    }
                });

                this.gestureHandler.on('doubleTap', () => {
                    this.switchCamera();
                });
            }

            setupVoiceControl() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    console.warn('Speech recognition not supported');
                    return;
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.speechRecognition = new SpeechRecognition();

                this.speechRecognition.continuous = true;
                this.speechRecognition.interimResults = true;
                this.speechRecognition.lang = 'zh-CN';

                this.speechRecognition.onresult = (event) => {
                    const results = Array.from(event.results);
                    const transcript = results
                        .map(result => result[0].transcript)
                        .join(' ')
                        .toLowerCase()
                        .trim();

                    this.processVoiceCommand(transcript);
                };

                this.speechRecognition.onerror = (event) => {
                    console.error('Voice recognition error:', event.error);
                };
            }

            processVoiceCommand(transcript) {
                const commands = {
                    '拍照': () => this.currentMode === 'photo' && this.takePhoto(),
                    '录像': () => this.setMode('video'),
                    '停止录像': () => this.stopRecording(),
                    '切换摄像头': () => this.switchCamera(),
                    '打开闪光灯': () => this.setFlash(true),
                    '关闭闪光灯': () => this.setFlash(false),
                    '分析': () => this.setMode('analysis'),
                    'AR模式': () => this.setMode('ar'),
                    '关闭': () => this.closeCamera(),
                    '放大': () => this.adjustZoom(1.2),
                    '缩小': () => this.adjustZoom(0.8)
                };

                for (const [command, action] of Object.entries(commands)) {
                    if (transcript.includes(command)) {
                        action();
                        this.showVoiceConfirmation(command);
                        break;
                    }
                }
            }

            async setupFaceDetection() {
                try {
                    if ('FaceDetector' in window) {
                        this.faceDetector = new FaceDetector({
                            maxDetectedFaces: 1,
                            fastMode: true
                        });
                    } else {
                        console.warn('Face detection not supported');
                    }
                } catch (error) {
                    console.warn('Face detection setup failed:', error);
                }
            }

            setMode(mode) {
                this.currentMode = mode;

                // Update UI
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.mode === mode);
                });

                // Update capture button
                const captureBtn = document.getElementById('captureBtn');
                captureBtn.classList.toggle('recording', mode === 'video' && this.isRecording);

                // Update analysis panel
                const analysisPanel = document.getElementById('analysisPanel');
                analysisPanel.classList.toggle('visible', mode === 'analysis');

                // Start/stop analysis
                if (mode === 'analysis') {
                    this.startAnalysis();
                } else {
                    this.stopAnalysis();
                }

                // Update camera constraints if needed
                if (mode === 'video' && !this.stream.getAudioTracks().length) {
                    this.restartCameraWithAudio();
                }
            }

            async restartCameraWithAudio() {
                try {
                    const constraints = {
                        video: {
                            facingMode: this.facingMode,
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: true
                    };

                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = this.stream;
                } catch (error) {
                    console.error('Failed to restart camera with audio:', error);
                }
            }

            handleCapture() {
                switch (this.currentMode) {
                    case 'photo':
                        this.takePhoto();
                        break;
                    case 'video':
                        if (this.isRecording) {
                            this.stopRecording();
                        } else {
                            this.startRecording();
                        }
                        break;
                    case 'ar':
                        this.captureAR();
                        break;
                    case 'analysis':
                        this.captureAnalysis();
                        break;
                }
            }

            takePhoto() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                canvas.width = this.video.videoWidth;
                canvas.height = this.video.videoHeight;

                // Draw video frame
                ctx.drawImage(this.video, 0, 0);

                // Add AR overlays if in AR mode
                if (this.currentMode === 'ar') {
                    this.drawAROverlays(ctx, canvas.width, canvas.height);
                }

                // Convert to blob and save
                canvas.toBlob((blob) => {
                    this.saveMedia(blob, 'photo');
                    this.showCaptureAnimation();
                }, 'image/jpeg', 0.9);
            }

            startRecording() {
                try {
                    const options = {
                        mimeType: 'video/webm;codecs=vp9,opus'
                    };

                    this.mediaRecorder = new MediaRecorder(this.stream, options);
                    this.recordedChunks = [];

                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.recordedChunks.push(event.data);
                        }
                    };

                    this.mediaRecorder.onstop = () => {
                        const blob = new Blob(this.recordedChunks, {
                            type: 'video/webm'
                        });
                        this.saveMedia(blob, 'video');
                    };

                    this.mediaRecorder.start();
                    this.isRecording = true;

                    document.getElementById('captureBtn').classList.add('recording');

                } catch (error) {
                    console.error('Recording failed:', error);
                }
            }

            stopRecording() {
                if (this.mediaRecorder && this.isRecording) {
                    this.mediaRecorder.stop();
                    this.isRecording = false;

                    document.getElementById('captureBtn').classList.remove('recording');
                }
            }

            captureAR() {
                // Capture with AR overlay
                this.takePhoto();
            }

            captureAnalysis() {
                // Capture with analysis data
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                canvas.width = this.video.videoWidth;
                canvas.height = this.video.videoHeight;

                ctx.drawImage(this.video, 0, 0);

                // Add analysis visualization
                this.drawAnalysisOverlay(ctx, canvas.width, canvas.height);

                canvas.toBlob((blob) => {
                    this.saveMedia(blob, 'analysis');
                    this.showCaptureAnimation();
                }, 'image/jpeg', 0.9);
            }

            saveMedia(blob, type) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');

                a.href = url;
                a.download = `lips-aesthetics-${type}-${timestamp}.${type === 'video' ? 'webm' : 'jpg'}`;
                a.click();

                URL.revokeObjectURL(url);

                // Store in local storage for gallery
                this.storeInLocalGallery(url, type, timestamp);
            }

            storeInLocalGallery(url, type, timestamp) {
                const gallery = JSON.parse(localStorage.getItem('lips-aesthetics-gallery') || '[]');
                gallery.unshift({
                    url,
                    type,
                    timestamp,
                    analysis: this.analysisResults
                });

                // Keep only last 50 items
                if (gallery.length > 50) {
                    gallery.splice(50);
                }

                localStorage.setItem('lips-aesthetics-gallery', JSON.stringify(gallery));
            }

            async switchCamera() {
                try {
                    this.facingMode = this.facingMode === 'user' ? 'environment' : 'user';

                    this.stream.getTracks().forEach(track => track.stop());
                    await this.setupCamera();

                } catch (error) {
                    console.error('Camera switch failed:', error);
                    // Revert on failure
                    this.facingMode = this.facingMode === 'user' ? 'environment' : 'user';
                }
            }

            toggleFlash() {
                this.setFlash(!this.flashEnabled);
            }

            async setFlash(enabled) {
                try {
                    const track = this.stream.getVideoTracks()[0];
                    const capabilities = track.getCapabilities();

                    if (capabilities.torch) {
                        await track.applyConstraints({
                            advanced: [{ torch: enabled }]
                        });

                        this.flashEnabled = enabled;
                        document.getElementById('flashBtn').classList.toggle('active', enabled);
                    }
                } catch (error) {
                    console.warn('Flash control not supported:', error);
                }
            }

            adjustZoom(factor) {
                try {
                    const track = this.stream.getVideoTracks()[0];
                    const capabilities = track.getCapabilities();

                    if (capabilities.zoom) {
                        const settings = track.getSettings();
                        const newZoom = Math.max(
                            capabilities.zoom.min,
                            Math.min(capabilities.zoom.max, settings.zoom * factor)
                        );

                        track.applyConstraints({
                            advanced: [{ zoom: newZoom }]
                        });
                    }
                } catch (error) {
                    console.warn('Zoom control not supported:', error);
                }
            }

            toggleVoiceControl() {
                if (this.voiceActive) {
                    this.stopVoiceControl();
                } else {
                    this.startVoiceControl();
                }
            }

            startVoiceControl() {
                if (this.speechRecognition) {
                    this.speechRecognition.start();
                    this.voiceActive = true;

                    document.getElementById('voiceIndicator').classList.add('active');
                    document.getElementById('voiceBtn').classList.add('active');
                }
            }

            stopVoiceControl() {
                if (this.speechRecognition) {
                    this.speechRecognition.stop();
                    this.voiceActive = false;

                    document.getElementById('voiceIndicator').classList.remove('active');
                    document.getElementById('voiceBtn').classList.remove('active');
                }
            }

            startAnalysis() {
                this.analysisActive = true;
                this.analyzeFrame();
            }

            stopAnalysis() {
                this.analysisActive = false;
            }

            async analyzeFrame() {
                if (!this.analysisActive) return;

                try {
                    if (this.faceDetector) {
                        const faces = await this.faceDetector.detect(this.video);

                        if (faces.length > 0) {
                            this.landmarks = faces[0].landmarks || [];
                            this.calculateAnalysis(faces[0]);
                            this.updateAnalysisUI();
                            this.drawAnalysisOverlay();
                        }
                    }
                } catch (error) {
                    console.warn('Analysis failed:', error);
                }

                if (this.analysisActive) {
                    requestAnimationFrame(() => this.analyzeFrame());
                }
            }

            calculateAnalysis(face) {
                // Mock analysis - in real implementation, use AI/ML models
                this.analysisResults = {
                    symmetry: (85 + Math.random() * 10).toFixed(1) + '%',
                    ratio: '1:' + (1.6 + Math.random() * 0.4).toFixed(1),
                    fullness: (75 + Math.random() * 15).toFixed(1) + '%',
                    color: (80 + Math.random() * 15).toFixed(1) + '%'
                };
            }

            updateAnalysisUI() {
                document.getElementById('symmetryValue').textContent = this.analysisResults.symmetry;
                document.getElementById('ratioValue').textContent = this.analysisResults.ratio;
                document.getElementById('fullnessValue').textContent = this.analysisResults.fullness;
                document.getElementById('colorValue').textContent = this.analysisResults.color;
            }

            drawAnalysisOverlay(ctx = this.ctx, width = this.canvas.width, height = this.canvas.height) {
                if (!this.analysisActive || this.landmarks.length === 0) return;

                ctx.clearRect(0, 0, width, height);
                ctx.strokeStyle = '#d4af37';
                ctx.fillStyle = 'rgba(212, 175, 55, 0.2)';
                ctx.lineWidth = 2;

                // Draw lip outline
                this.landmarks.forEach((point, index) => {
                    if (index === 0) {
                        ctx.beginPath();
                        ctx.moveTo(point.x, point.y);
                    } else {
                        ctx.lineTo(point.x, point.y);
                    }
                });

                ctx.closePath();
                ctx.stroke();
                ctx.fill();

                // Draw analysis points
                this.landmarks.forEach(point => {
                    ctx.beginPath();
                    ctx.arc(point.x, point.y, 3, 0, 2 * Math.PI);
                    ctx.fillStyle = '#d4af37';
                    ctx.fill();
                });
            }

            drawAROverlays(ctx, width, height) {
                // Draw AR effects
                ctx.strokeStyle = '#d4af37';
                ctx.lineWidth = 3;
                ctx.setLineDash([5, 5]);

                // Draw frame around detected area
                const frameSize = Math.min(width, height) * 0.6;
                const x = (width - frameSize) / 2;
                const y = (height - frameSize) / 2;

                ctx.strokeRect(x, y, frameSize, frameSize);

                // Add AR text
                ctx.fillStyle = '#d4af37';
                ctx.font = '20px Arial';
                ctx.fillText('AR 模式', 20, 40);
            }

            resizeCanvas() {
                const rect = this.video.getBoundingClientRect();
                this.canvas.width = rect.width;
                this.canvas.height = rect.height;
            }

            showCaptureAnimation() {
                const flash = document.createElement('div');
                flash.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: white;
                    z-index: 9999;
                    animation: flashAnimation 200ms ease-out;
                    pointer-events: none;
                `;

                const style = document.createElement('style');
                style.textContent = `
                    @keyframes flashAnimation {
                        0% { opacity: 0.8; }
                        100% { opacity: 0; }
                    }
                `;

                document.head.appendChild(style);
                document.body.appendChild(flash);

                setTimeout(() => {
                    document.body.removeChild(flash);
                    document.head.removeChild(style);
                }, 200);
            }

            showVoiceConfirmation(command) {
                const notification = document.createElement('div');
                notification.textContent = `语音命令: ${command}`;
                notification.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(212, 175, 55, 0.9);
                    color: white;
                    padding: 12px 24px;
                    border-radius: 8px;
                    z-index: 9999;
                    font-size: 16px;
                    animation: fadeInOut 2s ease-out;
                `;

                document.body.appendChild(notification);

                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 2000);
            }

            openGallery() {
                // Navigate to gallery with captured media
                window.location.href = '/gallery.html?source=camera';
            }

            nextMode() {
                const modes = ['photo', 'video', 'ar', 'analysis'];
                const currentIndex = modes.indexOf(this.currentMode);
                const nextIndex = (currentIndex + 1) % modes.length;
                this.setMode(modes[nextIndex]);
            }

            previousMode() {
                const modes = ['photo', 'video', 'ar', 'analysis'];
                const currentIndex = modes.indexOf(this.currentMode);
                const previousIndex = currentIndex === 0 ? modes.length - 1 : currentIndex - 1;
                this.setMode(modes[previousIndex]);
            }

            hideLoading() {
                document.getElementById('loadingIndicator').style.display = 'none';
            }

            showError(error) {
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                console.error('Camera error:', error);
            }

            closeCamera() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                }

                if (this.gestureHandler) {
                    this.gestureHandler.destroy();
                }

                this.stopVoiceControl();

                // Navigate back or close
                if (document.referrer) {
                    history.back();
                } else {
                    window.location.href = '/gallery.html';
                }
            }
        }

        // Initialize camera system when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new MobileCameraSystem();
        });

        // Add PWA styles for standalone mode
        if (window.matchMedia('(display-mode: standalone)').matches) {
            document.body.classList.add('pwa-mode');
        }

        // Handle visibility change for battery optimization
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Pause intensive operations when app is in background
                console.log('App went to background - optimizing performance');
            } else {
                console.log('App returned to foreground');
            }
        });
    </script>
</body>
</html>