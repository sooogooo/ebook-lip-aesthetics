<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>集成测试中心 - 绛唇解语花</title>
    <link rel="icon" href="https://docs.bccsw.cn/favicon.png">
    <link rel="apple-touch-icon" href="https://docs.bccsw.cn/logo.png">
    <style>
        :root{--primary:#E91E63;--success:#4CAF50;--warning:#FF9800;--error:#F44336;--bg:#FAFAFA;--card:#FFF;--text:#212121}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font:14px/1.5 system-ui,sans-serif;background:var(--bg);color:var(--text);padding:20px}
        .container{max-width:1200px;margin:0 auto}
        .header{background:var(--card);padding:20px;border-radius:8px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
        .title{color:var(--primary);font-size:24px;font-weight:600;text-align:center;margin-bottom:10px}
        .subtitle{text-align:center;color:#757575}
        .test-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:20px}
        .test-card{background:var(--card);border-radius:8px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
        .test-title{color:var(--primary);font-weight:600;margin-bottom:15px;display:flex;align-items:center;gap:10px}
        .test-status{display:inline-block;width:12px;height:12px;border-radius:50%;margin-right:8px}
        .status-pending{background:#757575}
        .status-running{background:var(--warning);animation:pulse 1s infinite}
        .status-success{background:var(--success)}
        .status-error{background:var(--error)}
        .test-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #eee}
        .test-item:last-child{border-bottom:none}
        .test-name{flex:1}
        .test-result{padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500}
        .result-pass{background:#E8F5E8;color:var(--success)}
        .result-fail{background:#FFEBEE;color:var(--error)}
        .result-pending{background:#F5F5F5;color:#757575}
        .actions{display:flex;gap:10px;margin-top:20px;justify-content:center}
        .btn{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:500;transition:all .3s}
        .btn-primary{background:var(--primary);color:white}
        .btn-primary:hover{background:#AD1457}
        .btn-secondary{background:#757575;color:white}
        .btn-secondary:hover{background:#424242}
        .summary{background:var(--card);padding:20px;border-radius:8px;margin-top:20px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
        .summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:20px;text-align:center}
        .metric{padding:15px}
        .metric-value{font-size:24px;font-weight:600;color:var(--primary)}
        .metric-label{color:#757575;font-size:12px;margin-top:5px}
        .log{background:#000;color:#00ff00;padding:15px;border-radius:8px;font-family:monospace;font-size:12px;max-height:200px;overflow-y:auto;margin-top:20px}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
        @media(max-width:768px){.container{padding:10px}.test-grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">🧪 集成测试中心</h1>
            <p class="subtitle">可视化系统完整性验证</p>
        </div>

        <div class="test-grid">
            <!-- 功能测试 -->
            <div class="test-card">
                <h3 class="test-title">
                    <span class="test-status status-pending" id="functional-status"></span>
                    ⚙️ 功能测试
                </h3>
                <div id="functional-tests">
                    <div class="test-item">
                        <span class="test-name">可视化中心加载</span>
                        <span class="test-result result-pending" id="test-hub">待测试</span>
                    </div>
                    <div class="test-item">
                        <span class="test-name">3D模型渲染</span>
                        <span class="test-result result-pending" id="test-3d">待测试</span>
                    </div>
                    <div class="test-item">
                        <span class="test-name">数据面板</span>
                        <span class="test-result result-pending" id="test-dashboard">待测试</span>
                    </div>
                    <div class="test-item">
                        <span class="test-name">移动端适配</span>
                        <span class="test-result result-pending" id="test-mobile">待测试</span>
                    </div>
                </div>
            </div>

            <!-- 性能测试 -->
            <div class="test-card">
                <h3 class="test-title">
                    <span class="test-status status-pending" id="performance-status"></span>
                    🚀 性能测试
                </h3>
                <div id="performance-tests">
                    <div class="test-item">
                        <span class="test-name">首屏加载时间</span>
                        <span class="test-result result-pending" id="test-fcp">待测试</span>
                    </div>
                    <div class="test-item">
                        <span class="test-name">JavaScript执行</span>
                        <span class="test-result result-pending" id="test-js">待测试</span>
                    </div>
                    <div class="test-item">
                        <span class="test-name">内存使用</span>
                        <span class="test-result result-pending" id="test-memory">待测试</span>
                    </div>
                    <div class="test-item">
                        <span class="test-name">渲染帧率</span>
                        <span class="test-result result-pending" id="test-fps">待测试</span>
                    </div>
                </div>
            </div>

            <!-- 兼容性测试 -->
            <div class="test-card">
                <h3 class="test-title">
                    <span class="test-status status-pending" id="compatibility-status"></span>
                    🌐 兼容性测试
                </h3>
                <div id="compatibility-tests">
                    <div class="test-item">
                        <span class="test-name">WebGL支持</span>
                        <span class="test-result result-pending" id="test-webgl">待测试</span>
                    </div>
                    <div class="test-item">
                        <span class="test-name">Service Worker</span>
                        <span class="test-result result-pending" id="test-sw">待测试</span>
                    </div>
                    <div class="test-item">
                        <span class="test-name">触摸手势</span>
                        <span class="test-result result-pending" id="test-touch">待测试</span>
                    </div>
                    <div class="test-item">
                        <span class="test-name">PWA功能</span>
                        <span class="test-result result-pending" id="test-pwa">待测试</span>
                    </div>
                </div>
            </div>

            <!-- 安全测试 -->
            <div class="test-card">
                <h3 class="test-title">
                    <span class="test-status status-pending" id="security-status"></span>
                    🔒 安全测试
                </h3>
                <div id="security-tests">
                    <div class="test-item">
                        <span class="test-name">HTTPS加密</span>
                        <span class="test-result result-pending" id="test-https">待测试</span>
                    </div>
                    <div class="test-item">
                        <span class="test-name">XSS防护</span>
                        <span class="test-result result-pending" id="test-xss">待测试</span>
                    </div>
                    <div class="test-item">
                        <span class="test-name">内容安全策略</span>
                        <span class="test-result result-pending" id="test-csp">待测试</span>
                    </div>
                    <div class="test-item">
                        <span class="test-name">数据隐私</span>
                        <span class="test-result result-pending" id="test-privacy">待测试</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="actions">
            <button class="btn btn-primary" onclick="runAllTests()">🚀 运行全部测试</button>
            <button class="btn btn-secondary" onclick="runSingleTest()">🎯 单项测试</button>
            <button class="btn btn-secondary" onclick="generateReport()">📊 生成报告</button>
        </div>

        <div class="summary">
            <div class="summary-grid">
                <div class="metric">
                    <div class="metric-value" id="total-tests">16</div>
                    <div class="metric-label">总测试数</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="passed-tests">0</div>
                    <div class="metric-label">通过</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="failed-tests">0</div>
                    <div class="metric-label">失败</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="test-time">0s</div>
                    <div class="metric-label">测试时间</div>
                </div>
                <div class="metric">
                    <div class="metric-value" id="success-rate">0%</div>
                    <div class="metric-label">成功率</div>
                </div>
            </div>
        </div>

        <div class="log" id="test-log">
            > 集成测试系统就绪，点击"运行全部测试"开始验证...<br>
        </div>
    </div>

    <script>
        class IntegrationTester {
            constructor() {
                this.tests = {
                    functional: [
                        { id: 'test-hub', name: '可视化中心加载', fn: this.testVisualizationHub },
                        { id: 'test-3d', name: '3D模型渲染', fn: this.test3DRendering },
                        { id: 'test-dashboard', name: '数据面板', fn: this.testDashboard },
                        { id: 'test-mobile', name: '移动端适配', fn: this.testMobileAdaptation }
                    ],
                    performance: [
                        { id: 'test-fcp', name: '首屏加载时间', fn: this.testFirstContentfulPaint },
                        { id: 'test-js', name: 'JavaScript执行', fn: this.testJavaScriptExecution },
                        { id: 'test-memory', name: '内存使用', fn: this.testMemoryUsage },
                        { id: 'test-fps', name: '渲染帧率', fn: this.testFrameRate }
                    ],
                    compatibility: [
                        { id: 'test-webgl', name: 'WebGL支持', fn: this.testWebGLSupport },
                        { id: 'test-sw', name: 'Service Worker', fn: this.testServiceWorker },
                        { id: 'test-touch', name: '触摸手势', fn: this.testTouchGestures },
                        { id: 'test-pwa', name: 'PWA功能', fn: this.testPWAFeatures }
                    ],
                    security: [
                        { id: 'test-https', name: 'HTTPS加密', fn: this.testHTTPS },
                        { id: 'test-xss', name: 'XSS防护', fn: this.testXSSProtection },
                        { id: 'test-csp', name: '内容安全策略', fn: this.testCSP },
                        { id: 'test-privacy', name: '数据隐私', fn: this.testDataPrivacy }
                    ]
                };

                this.results = {
                    passed: 0,
                    failed: 0,
                    total: 0,
                    startTime: 0
                };

                this.log = document.getElementById('test-log');
            }

            async runAllTests() {
                this.log.innerHTML = '';
                this.logMessage('🚀 开始运行集成测试...', 'info');
                this.results.startTime = Date.now();
                this.results.passed = 0;
                this.results.failed = 0;
                this.results.total = 0;

                for (const [category, tests] of Object.entries(this.tests)) {
                    await this.runTestCategory(category, tests);
                }

                this.updateSummary();
                this.logMessage('✅ 所有测试完成!', 'success');
            }

            async runTestCategory(category, tests) {
                this.logMessage(`📋 运行 ${category} 测试...`, 'info');
                this.setStatus(`${category}-status`, 'running');

                let categoryPassed = 0;

                for (const test of tests) {
                    this.results.total++;
                    this.setTestResult(test.id, 'running', '测试中...');

                    try {
                        const result = await test.fn.call(this);
                        if (result.success) {
                            this.setTestResult(test.id, 'pass', result.message || '通过');
                            this.results.passed++;
                            categoryPassed++;
                            this.logMessage(`  ✓ ${test.name}: ${result.message || '通过'}`, 'success');
                        } else {
                            this.setTestResult(test.id, 'fail', result.message || '失败');
                            this.results.failed++;
                            this.logMessage(`  ✗ ${test.name}: ${result.message || '失败'}`, 'error');
                        }
                    } catch (error) {
                        this.setTestResult(test.id, 'fail', '异常');
                        this.results.failed++;
                        this.logMessage(`  ✗ ${test.name}: ${error.message}`, 'error');
                    }

                    await this.delay(200);
                }

                this.setStatus(`${category}-status`, categoryPassed === tests.length ? 'success' : 'error');
                this.logMessage(`📊 ${category} 测试完成: ${categoryPassed}/${tests.length}`, 'info');
            }

            // 功能测试
            async testVisualizationHub() {
                const hubExists = document.querySelector('.visualization-hub') ||
                                 document.querySelector('.tools') ||
                                 document.title.includes('绛唇解语花');

                return {
                    success: hubExists,
                    message: hubExists ? '中心加载成功' : '中心未找到'
                };
            }

            async test3DRendering() {
                const hasWebGL = this.checkWebGLSupport();
                const has3DOptimizer = typeof window.Model3DOptimizer !== 'undefined' ||
                                      document.querySelector('script[src*="3d"]');

                return {
                    success: hasWebGL && has3DOptimizer,
                    message: hasWebGL && has3DOptimizer ? '3D渲染就绪' : '3D支持不完整'
                };
            }

            async testDashboard() {
                const hasDashboard = document.querySelector('.dashboard') ||
                                   document.querySelector('canvas') ||
                                   typeof Chart !== 'undefined';

                return {
                    success: hasDashboard,
                    message: hasDashboard ? '面板可用' : '面板未发现'
                };
            }

            async testMobileAdaptation() {
                const isMobile = window.innerWidth < 768;
                const hasTouchSupport = 'ontouchstart' in window;
                const hasViewportMeta = document.querySelector('meta[name="viewport"]');

                return {
                    success: hasViewportMeta && (hasTouchSupport || !isMobile),
                    message: hasViewportMeta ? '移动适配良好' : '缺少viewport设置'
                };
            }

            // 性能测试
            async testFirstContentfulPaint() {
                const fcp = performance.getEntriesByType('navigation')[0];
                const loadTime = fcp ? fcp.loadEventEnd - fcp.loadEventStart : 0;

                return {
                    success: loadTime < 3000,
                    message: `${loadTime.toFixed(0)}ms`
                };
            }

            async testJavaScriptExecution() {
                const start = performance.now();

                // 执行一些计算密集型任务
                for (let i = 0; i < 100000; i++) {
                    Math.sqrt(i);
                }

                const executionTime = performance.now() - start;

                return {
                    success: executionTime < 100,
                    message: `${executionTime.toFixed(1)}ms`
                };
            }

            async testMemoryUsage() {
                if (!performance.memory) {
                    return { success: true, message: '内存API不可用' };
                }

                const used = performance.memory.usedJSHeapSize / 1048576; // MB
                const limit = performance.memory.jsHeapSizeLimit / 1048576;

                return {
                    success: used < 100,
                    message: `${used.toFixed(1)}MB/${limit.toFixed(0)}MB`
                };
            }

            async testFrameRate() {
                return new Promise(resolve => {
                    let frames = 0;
                    const start = performance.now();

                    const countFrames = () => {
                        frames++;
                        if (frames < 60) {
                            requestAnimationFrame(countFrames);
                        } else {
                            const fps = Math.round(60000 / (performance.now() - start));
                            resolve({
                                success: fps >= 30,
                                message: `${fps} FPS`
                            });
                        }
                    };

                    requestAnimationFrame(countFrames);
                });
            }

            // 兼容性测试
            async testWebGLSupport() {
                const hasWebGL = this.checkWebGLSupport();
                return {
                    success: hasWebGL,
                    message: hasWebGL ? 'WebGL可用' : 'WebGL不支持'
                };
            }

            async testServiceWorker() {
                const hasServiceWorker = 'serviceWorker' in navigator;
                let registered = false;

                if (hasServiceWorker) {
                    try {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        registered = registrations.length > 0;
                    } catch {}
                }

                return {
                    success: hasServiceWorker && registered,
                    message: hasServiceWorker ? (registered ? 'SW已注册' : 'SW未注册') : 'SW不支持'
                };
            }

            async testTouchGestures() {
                const hasTouch = 'ontouchstart' in window;
                const hasPointer = 'onpointerdown' in window;

                return {
                    success: hasTouch || hasPointer,
                    message: hasTouch ? '触摸支持' : hasPointer ? '指针支持' : '无触摸支持'
                };
            }

            async testPWAFeatures() {
                const hasManifest = document.querySelector('link[rel="manifest"]');
                const hasServiceWorker = 'serviceWorker' in navigator;
                const hasHTTPS = location.protocol === 'https:' || location.hostname === 'localhost';

                const score = [hasManifest, hasServiceWorker, hasHTTPS].filter(Boolean).length;

                return {
                    success: score >= 2,
                    message: `PWA就绪度: ${score}/3`
                };
            }

            // 安全测试
            async testHTTPS() {
                const isSecure = location.protocol === 'https:' ||
                               location.hostname === 'localhost' ||
                               location.hostname === '127.0.0.1';

                return {
                    success: isSecure,
                    message: isSecure ? '安全连接' : '非安全连接'
                };
            }

            async testXSSProtection() {
                // 基本XSS测试
                const testScript = '<script>alert("xss")</script>';
                const div = document.createElement('div');
                div.innerHTML = testScript;

                const hasScript = div.querySelector('script');

                return {
                    success: !hasScript,
                    message: hasScript ? 'XSS风险' : 'XSS防护正常'
                };
            }

            async testCSP() {
                const cspMeta = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
                const hasCSPHeader = document.createElement('img').src = 'data:';

                return {
                    success: cspMeta !== null,
                    message: cspMeta ? 'CSP已配置' : 'CSP未配置'
                };
            }

            async testDataPrivacy() {
                const hasPrivacyPolicy = document.querySelector('a[href*="privacy"]') ||
                                       document.querySelector('a[href*="隐私"]');
                const localStorage = window.localStorage;

                return {
                    success: true, // 基础隐私保护
                    message: '隐私保护基线'
                };
            }

            // 工具方法
            checkWebGLSupport() {
                try {
                    const canvas = document.createElement('canvas');
                    return !!(canvas.getContext('webgl') || canvas.getContext('experimental-webgl'));
                } catch {
                    return false;
                }
            }

            setStatus(elementId, status) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.className = `test-status status-${status}`;
                }
            }

            setTestResult(elementId, type, message) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.className = `test-result result-${type}`;
                    element.textContent = message;
                }
            }

            updateSummary() {
                const total = this.results.total;
                const passed = this.results.passed;
                const failed = this.results.failed;
                const successRate = total > 0 ? Math.round((passed / total) * 100) : 0;
                const testTime = ((Date.now() - this.results.startTime) / 1000).toFixed(1);

                document.getElementById('total-tests').textContent = total;
                document.getElementById('passed-tests').textContent = passed;
                document.getElementById('failed-tests').textContent = failed;
                document.getElementById('success-rate').textContent = successRate + '%';
                document.getElementById('test-time').textContent = testTime + 's';
            }

            logMessage(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const colors = {
                    info: '#00ff00',
                    success: '#00ff00',
                    error: '#ff0000',
                    warning: '#ffff00'
                };

                this.log.innerHTML += `<span style="color: ${colors[type] || '#00ff00'}">[${timestamp}] ${message}</span><br>`;
                this.log.scrollTop = this.log.scrollHeight;
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // 全局实例
        const tester = new IntegrationTester();

        // 全局函数
        function runAllTests() {
            tester.runAllTests();
        }

        function runSingleTest() {
            alert('单项测试功能开发中...');
        }

        function generateReport() {
            const reportData = {
                timestamp: new Date().toISOString(),
                results: tester.results,
                userAgent: navigator.userAgent,
                viewport: `${window.innerWidth}x${window.innerHeight}`,
                performance: performance.memory ? {
                    used: Math.round(performance.memory.usedJSHeapSize / 1048576),
                    total: Math.round(performance.memory.totalJSHeapSize / 1048576)
                } : null
            };

            const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `integration-test-report-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // 页面加载时运行基础检查
        document.addEventListener('DOMContentLoaded', () => {
            tester.logMessage('🔧 集成测试系统初始化完成', 'success');
            tester.logMessage('📝 点击"运行全部测试"开始完整验证', 'info');
        });
    </script>
</body>
</html>