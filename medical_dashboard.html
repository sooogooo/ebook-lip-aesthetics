<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lip Aesthetics Medical Dashboard</title>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="medical_data_analytics.js"></script>
    <script type="module" src="advanced_medical_visualization.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>

    <style>
        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #4a90e2;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --background-color: #f8fafc;
            --card-background: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --border-color: #e1e5e9;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .dashboard-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        /* Controls */
        .controls {
            background: var(--card-background);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .control-group label {
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .control-group select,
        .control-group input {
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
            min-width: 150px;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #1e3a73;
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #1e8449;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        /* Cards */
        .card {
            background: var(--card-background);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .card h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .card-large {
            grid-column: span 2;
        }

        /* Stats Cards */
        .stats-grid {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            background: var(--card-background);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-content h4 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }

        .stat-content p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.3;
        }

        /* Chart Containers */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }

        .chart-container.large {
            height: 400px;
        }

        /* D3 Specific Styles */
        .d3-chart {
            width: 100%;
            height: 100%;
        }

        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .controls {
                padding: 1rem;
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                width: 100%;
            }

            .main-content {
                padding: 1rem;
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .card-large {
                grid-column: span 1;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 250px;
            }

            .chart-container.large {
                height: 300px;
            }
        }

        @media (max-width: 480px) {
            .stat-card {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }

            .stat-content h4 {
                font-size: 1.5rem;
            }
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Export Menu */
        .export-menu {
            position: relative;
            display: inline-block;
        }

        .export-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-shadow: var(--shadow);
            z-index: 1000;
            min-width: 200px;
        }

        .export-dropdown.show {
            display: block;
        }

        .export-dropdown a {
            display: block;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            text-decoration: none;
            border-bottom: 1px solid var(--border-color);
        }

        .export-dropdown a:hover {
            background: var(--background-color);
        }

        .alert-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .alert-warning::before {
            content: '⚠️';
            font-size: 1.5rem;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="header">
            <h1>Lip Aesthetics Medical Dashboard</h1>
            <p>Comprehensive analytics for aesthetic procedures and patient outcomes</p>
        </header>

        <!-- Controls -->
        <div class="controls">
            <div class="control-group">
                <label for="dateFrom">Date From</label>
                <input type="date" id="dateFrom" value="2024-01-01">
            </div>
            <div class="control-group">
                <label for="dateTo">Date To</label>
                <input type="date" id="dateTo" value="2024-12-31">
            </div>
            <div class="control-group">
                <label for="procedureFilter">Procedure Type</label>
                <select id="procedureFilter">
                    <option value="all">All Procedures</option>
                    <option value="lip-filler">Lip Filler</option>
                    <option value="lip-lift">Lip Lift</option>
                    <option value="lip-reduction">Lip Reduction</option>
                    <option value="lip-implants">Lip Implants</option>
                </select>
            </div>
            <div class="control-group">
                <label for="doctorFilter">Doctor</label>
                <select id="doctorFilter">
                    <option value="all">All Doctors</option>
                    <option value="dr-smith">Dr. Smith</option>
                    <option value="dr-johnson">Dr. Johnson</option>
                    <option value="dr-williams">Dr. Williams</option>
                    <option value="dr-brown">Dr. Brown</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="updateDashboard()">
                <span>🔄</span> Refresh Data
            </button>
            <div class="export-menu">
                <button class="btn btn-success" onclick="toggleExportMenu()">
                    <span>📊</span> Export Report
                </button>
                <div class="export-dropdown" id="exportDropdown">
                    <a href="#" onclick="exportData('pdf')">📄 Export as PDF</a>
                    <a href="#" onclick="exportData('excel')">📊 Export as Excel</a>
                    <a href="#" onclick="exportData('csv')">📋 Export as CSV</a>
                    <a href="#" onclick="exportData('png')">🖼️ Export Charts as PNG</a>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Data Quality Warning -->
            <div id="dataQualityWarning" class="alert alert-warning" style="display: none; margin-bottom: 1rem;">
                Data Quality Warning
            </div>

            <!-- Statistics Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-content">
                        <h4 id="totalPatients">1,247</h4>
                        <p>Total Patients</p>
                    </div>
                    <div class="stat-icon">👥</div>
                </div>
                <div class="stat-card">
                    <div class="stat-content">
                        <h4 id="totalProcedures">1,683</h4>
                        <p>Total Procedures</p>
                    </div>
                    <div class="stat-icon">💉</div>
                </div>
                <div class="stat-card">
                    <div class="stat-content">
                        <h4 id="successRate">96.2%</h4>
                        <p>Success Rate</p>
                    </div>
                    <div class="stat-icon">✅</div>
                </div>
                <div class="stat-card">
                    <div class="stat-content">
                        <h4 id="avgSatisfaction">4.7</h4>
                        <p>Avg Satisfaction (5.0)</p>
                    </div>
                    <div class="stat-icon">⭐</div>
                </div>
            </div>

            <!-- Patient Demographics -->
            <div class="card">
                <h3>Patient Age Distribution</h3>
                <div class="chart-container">
                    <canvas id="ageDistributionChart"></canvas>
                </div>
            </div>

            <!-- Procedure Popularity -->
            <div class="card">
                <h3>Procedure Type Popularity</h3>
                <div class="chart-container">
                    <canvas id="procedurePopularityChart"></canvas>
                </div>
            </div>

            <!-- Success Rate Trends -->
            <div class="card card-large">
                <h3>Success Rate Trends Over Time</h3>
                <div class="chart-container large">
                    <canvas id="successTrendsChart"></canvas>
                </div>
            </div>

            <!-- Recovery Timeline -->
            <div class="card">
                <h3>Recovery Time Statistics</h3>
                <div class="chart-container">
                    <canvas id="recoveryTimeChart"></canvas>
                </div>
            </div>

            <!-- Doctor Performance -->
            <div class="card">
                <h3>Doctor Performance Metrics</h3>
                <div class="chart-container">
                    <div id="doctorPerformanceChart" class="d3-chart"></div>
                </div>
            </div>

            <!-- Satisfaction Over Time -->
            <div class="card card-large">
                <h3>Patient Satisfaction Scores Over Time</h3>
                <div class="chart-container large">
                    <canvas id="satisfactionChart"></canvas>
                </div>
            </div>

            <!-- Complications Heatmap -->
            <div class="card card-large">
                <h3>Complication Rate Heatmap by Procedure & Age Group</h3>
                <div class="chart-container large">
                    <div id="complicationHeatmap" class="d3-chart"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Tooltip for D3 Charts -->
    <div id="tooltip" class="tooltip"></div>

    <script>
        // Global variables for charts
        let charts = {};

        // Sample data generation
        function generateSampleData() {
            return {
                ageDistribution: [
                    { age: '18-25', count: 287 },
                    { age: '26-35', count: 445 },
                    { age: '36-45', count: 312 },
                    { age: '46-55', count: 156 },
                    { age: '56+', count: 47 }
                ],
                procedurePopularity: [
                    { procedure: 'Lip Filler', count: 856, percentage: 50.9 },
                    { procedure: 'Lip Lift', count: 423, percentage: 25.1 },
                    { procedure: 'Lip Reduction', count: 267, percentage: 15.9 },
                    { procedure: 'Lip Implants', count: 137, percentage: 8.1 }
                ],
                successTrends: generateMonthlyData('success', 96.2, 2),
                recoveryTime: [
                    { procedure: 'Lip Filler', avgDays: 3, minDays: 1, maxDays: 7 },
                    { procedure: 'Lip Lift', avgDays: 14, minDays: 10, maxDays: 21 },
                    { procedure: 'Lip Reduction', avgDays: 10, minDays: 7, maxDays: 14 },
                    { procedure: 'Lip Implants', avgDays: 12, minDays: 8, maxDays: 18 }
                ],
                doctorPerformance: [
                    { doctor: 'Dr. Smith', procedures: 423, successRate: 97.2, satisfaction: 4.8 },
                    { doctor: 'Dr. Johnson', procedures: 389, successRate: 95.8, satisfaction: 4.6 },
                    { doctor: 'Dr. Williams', procedures: 456, successRate: 96.5, satisfaction: 4.7 },
                    { doctor: 'Dr. Brown', procedures: 415, successRate: 95.1, satisfaction: 4.5 }
                ],
                satisfactionTrends: generateMonthlyData('satisfaction', 4.7, 0.3),
                complicationRates: generateComplicationHeatmapData()
            };
        }

        function generateMonthlyData(type, baseline, variance) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return months.map(month => ({
                month,
                value: baseline + (Math.random() - 0.5) * variance
            }));
        }

        function generateComplicationHeatmapData() {
            const procedures = ['Lip Filler', 'Lip Lift', 'Lip Reduction', 'Lip Implants'];
            const ageGroups = ['18-25', '26-35', '36-45', '46-55', '56+'];
            const data = [];

            procedures.forEach((procedure, i) => {
                ageGroups.forEach((ageGroup, j) => {
                    data.push({
                        procedure,
                        ageGroup,
                        rate: Math.random() * 5 + (i * 0.5) + (j * 0.3) // Simulated complication rate
                    });
                });
            });

            return data;
        }

        // Chart.js configurations
        const chartConfigs = {
            ageDistribution: {
                type: 'doughnut',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            },
            procedurePopularity: {
                type: 'bar',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            },
            successTrends: {
                type: 'line',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: 90,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            },
            recoveryTime: {
                type: 'bar',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Days'
                            }
                        }
                    }
                }
            },
            satisfactionChart: {
                type: 'line',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: 4.0,
                            max: 5.0
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            }
        };

        // Initialize charts
        function initializeCharts() {
            const data = generateSampleData();

            // Age Distribution Chart
            charts.ageDistribution = new Chart(document.getElementById('ageDistributionChart'), {
                ...chartConfigs.ageDistribution,
                data: {
                    labels: data.ageDistribution.map(d => d.age),
                    datasets: [{
                        data: data.ageDistribution.map(d => d.count),
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF'
                        ]
                    }]
                }
            });

            // Procedure Popularity Chart
            charts.procedurePopularity = new Chart(document.getElementById('procedurePopularityChart'), {
                ...chartConfigs.procedurePopularity,
                data: {
                    labels: data.procedurePopularity.map(d => d.procedure),
                    datasets: [{
                        data: data.procedurePopularity.map(d => d.count),
                        backgroundColor: '#4a90e2',
                        borderColor: '#2c5aa0',
                        borderWidth: 1
                    }]
                }
            });

            // Success Trends Chart
            charts.successTrends = new Chart(document.getElementById('successTrendsChart'), {
                ...chartConfigs.successTrends,
                data: {
                    labels: data.successTrends.map(d => d.month),
                    datasets: [{
                        label: 'Success Rate (%)',
                        data: data.successTrends.map(d => d.value),
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                }
            });

            // Recovery Time Chart
            charts.recoveryTime = new Chart(document.getElementById('recoveryTimeChart'), {
                ...chartConfigs.recoveryTime,
                data: {
                    labels: data.recoveryTime.map(d => d.procedure),
                    datasets: [{
                        label: 'Average Days',
                        data: data.recoveryTime.map(d => d.avgDays),
                        backgroundColor: '#f39c12',
                        borderColor: '#e67e22',
                        borderWidth: 1
                    }]
                }
            });

            // Satisfaction Chart
            charts.satisfactionChart = new Chart(document.getElementById('satisfactionChart'), {
                ...chartConfigs.satisfactionChart,
                data: {
                    labels: data.satisfactionTrends.map(d => d.month),
                    datasets: [{
                        label: 'Satisfaction Score',
                        data: data.satisfactionTrends.map(d => d.value),
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                }
            });

            // D3.js Charts
            createDoctorPerformanceChart(data.doctorPerformance);
            createComplicationHeatmap(data.complicationRates);
        }

        // D3.js Doctor Performance Chart
        function createDoctorPerformanceChart(data) {
            const container = d3.select('#doctorPerformanceChart');
            container.selectAll('*').remove();

            const margin = { top: 20, right: 30, bottom: 40, left: 100 };
            const width = container.node().offsetWidth - margin.left - margin.right;
            const height = 250 - margin.top - margin.bottom;

            const svg = container.append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const xScale = d3.scaleLinear()
                .domain([94, 98])
                .range([0, width]);

            const yScale = d3.scaleBand()
                .domain(data.map(d => d.doctor))
                .range([0, height])
                .padding(0.1);

            const colorScale = d3.scaleSequential(d3.interpolateBlues)
                .domain(d3.extent(data, d => d.satisfaction));

            // Add bars
            g.selectAll('.bar')
                .data(data)
                .enter().append('rect')
                .attr('class', 'bar')
                .attr('x', d => xScale(94))
                .attr('y', d => yScale(d.doctor))
                .attr('width', d => xScale(d.successRate) - xScale(94))
                .attr('height', yScale.bandwidth())
                .attr('fill', d => colorScale(d.satisfaction))
                .on('mouseover', function(event, d) {
                    showTooltip(event, `${d.doctor}<br/>Success Rate: ${d.successRate}%<br/>Satisfaction: ${d.satisfaction}/5<br/>Procedures: ${d.procedures}`);
                })
                .on('mouseout', hideTooltip);

            // Add axes
            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale));

            g.append('g')
                .call(d3.axisLeft(yScale));

            // Add title
            g.append('text')
                .attr('x', width / 2)
                .attr('y', -5)
                .attr('text-anchor', 'middle')
                .style('font-size', '12px')
                .style('font-weight', 'bold')
                .text('Success Rate by Doctor (Color = Satisfaction)');
        }

        // D3.js Complication Heatmap
        function createComplicationHeatmap(data) {
            const container = d3.select('#complicationHeatmap');
            container.selectAll('*').remove();

            const margin = { top: 50, right: 50, bottom: 50, left: 100 };
            const width = container.node().offsetWidth - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            const svg = container.append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const procedures = [...new Set(data.map(d => d.procedure))];
            const ageGroups = [...new Set(data.map(d => d.ageGroup))];

            const xScale = d3.scaleBand()
                .domain(ageGroups)
                .range([0, width])
                .padding(0.05);

            const yScale = d3.scaleBand()
                .domain(procedures)
                .range([0, height])
                .padding(0.05);

            const colorScale = d3.scaleSequential(d3.interpolateReds)
                .domain(d3.extent(data, d => d.rate));

            // Add rectangles
            g.selectAll('.heatmap-rect')
                .data(data)
                .enter().append('rect')
                .attr('class', 'heatmap-rect')
                .attr('x', d => xScale(d.ageGroup))
                .attr('y', d => yScale(d.procedure))
                .attr('width', xScale.bandwidth())
                .attr('height', yScale.bandwidth())
                .attr('fill', d => colorScale(d.rate))
                .attr('stroke', 'white')
                .attr('stroke-width', 1)
                .on('mouseover', function(event, d) {
                    showTooltip(event, `${d.procedure} - ${d.ageGroup}<br/>Complication Rate: ${d.rate.toFixed(1)}%`);
                })
                .on('mouseout', hideTooltip);

            // Add axes
            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale));

            g.append('g')
                .call(d3.axisLeft(yScale));

            // Add labels
            g.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', 0 - margin.left)
                .attr('x', 0 - (height / 2))
                .attr('dy', '1em')
                .style('text-anchor', 'middle')
                .style('font-size', '12px')
                .text('Procedure Type');

            g.append('text')
                .attr('transform', `translate(${width / 2}, ${height + margin.bottom - 10})`)
                .style('text-anchor', 'middle')
                .style('font-size', '12px')
                .text('Age Group');
        }

        // Tooltip functions
        function showTooltip(event, content) {
            const tooltip = d3.select('#tooltip');
            tooltip.style('opacity', 1)
                .html(content)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px');
        }

        function hideTooltip() {
            d3.select('#tooltip').style('opacity', 0);
        }

        // Dashboard functions
        // Real-time data streaming simulation
        const dataAnalytics = new MedicalDataAnalytics();
        const medicalVisualizer = new MedicalDataVisualizer();

        function updateDashboard() {
            // Advanced data refresh with quality assessment
            const loadingElements = document.querySelectorAll('.chart-container');
            loadingElements.forEach(el => {
                el.innerHTML = '<div class="loading"><div class="spinner"></div>Data Validation & Refresh...</div>';
            });

            // Simulate data retrieval and analytics
            const sampleDataSet = generateSampleData();
            const dataQualityReport = dataAnalytics.assessDataQuality(sampleDataSet);

            setTimeout(() => {
                // Update statistics with quality-enhanced data
                const statistics = {
                    totalPatients: Math.floor(Math.random() * 500 + 1000),
                    totalProcedures: Math.floor(Math.random() * 700 + 1500),
                    successRate: (Math.random() * 5 + 95).toFixed(1) + '%',
                    avgSatisfaction: (Math.random() * 0.5 + 4.5).toFixed(1)
                };

                // Apply quality validation
                if (dataQualityReport.overallQualityScore > 80) {
                    document.getElementById('totalPatients').textContent = statistics.totalPatients;
                    document.getElementById('totalProcedures').textContent = statistics.totalProcedures;
                    document.getElementById('successRate').textContent = statistics.successRate;
                    document.getElementById('avgSatisfaction').textContent = statistics.avgSatisfaction;
                } else {
                    // Show data quality warning
                    document.getElementById('dataQualityWarning').style.display = 'block';
                    document.getElementById('dataQualityWarning').textContent =
                        `Data Quality Alert: ${dataQualityReport.recommendations.join(', ')}`;
                }

                // Reinitialize charts with advanced visualization
                Object.values(charts).forEach(chart => {
                    if (chart && typeof chart.destroy === 'function') {
                        chart.destroy();
                    }
                });

                charts = {};
                initializeCharts();
            }, 2000);
        }

        function toggleExportMenu() {
            const dropdown = document.getElementById('exportDropdown');
            dropdown.classList.toggle('show');
        }

        function exportData(format) {
            // Simulate export functionality
            alert(`Exporting data as ${format.toUpperCase()}... This would generate a ${format} file with all dashboard data.`);
            document.getElementById('exportDropdown').classList.remove('show');
        }

        // Initialize dashboard
        <!-- Browser Compatibility Check -->
    <noscript>
        <div class="alert alert-warning">
            JavaScript is required for this dashboard. Please enable JavaScript in your browser settings.
        </div>
    </noscript>
    <div id="browser-compatibility-warning" class="alert alert-warning" style="display: none;">
        Your browser might not support all dashboard features. Please use a modern browser like Chrome, Firefox, Safari, or Edge.
    </div>

    <script>
        // Browser feature detection
        function checkBrowserCompatibility() {
            const incompatibilities = [];

            if (!window.fetch) incompatibilities.push('Fetch API');
            if (!window.Promise) incompatibilities.push('Promises');
            if (!window.Map || !window.Set) incompatibilities.push('Modern JavaScript Collections');
            if (!document.querySelector) incompatibilities.push('Modern DOM Selectors');

            if (incompatibilities.length > 0) {
                const warningElement = document.getElementById('browser-compatibility-warning');
                warningElement.innerHTML = `
                    Your browser might not support all dashboard features.
                    Missing support for: ${incompatibilities.join(', ')}.
                    Please use a modern browser like Chrome, Firefox, Safari, or Edge.
                `;
                warningElement.style.display = 'block';
                return false;
            }
            return true;
        }

        // Performance and error monitoring
        window.addEventListener('error', function(event) {
            console.error('Unhandled error:', event.error);
            document.getElementById('dataQualityWarning').style.display = 'block';
            document.getElementById('dataQualityWarning').textContent =
                `Dashboard Error: ${event.message || 'An unexpected error occurred'}. Please refresh the page.`;
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Browser compatibility check
            checkBrowserCompatibility();

            // Global error handler for more robust error tracking
            window.addEventListener('unhandledrejection', function(event) {
                console.error('Unhandled promise rejection:', event.reason);
                document.getElementById('dataQualityWarning').style.display = 'block';
                document.getElementById('dataQualityWarning').textContent =
                    `Dashboard Error: ${event.reason || 'An unexpected error occurred'}. Please refresh the page.`;
            });
        });
    </script>
            // Set current date in date inputs
            const today = new Date();
            const currentYear = today.getFullYear();
            document.getElementById('dateTo').value = today.toISOString().split('T')[0];
            document.getElementById('dateFrom').value = `${currentYear}-01-01`;

            // Initialize charts
            initializeCharts();

            // Close export dropdown when clicking outside
            document.addEventListener('click', function(event) {
                const exportMenu = document.querySelector('.export-menu');
                if (!exportMenu.contains(event.target)) {
                    document.getElementById('exportDropdown').classList.remove('show');
                }
            });

            // Efficient real-time data update
            const statisticsElements = {
                totalPatients: document.getElementById('totalPatients'),
                totalProcedures: document.getElementById('totalProcedures'),
                successRate: document.getElementById('successRate'),
                avgSatisfaction: document.getElementById('avgSatisfaction')
            };

            function updateStatistics() {
                const updates = {
                    totalPatients: Math.floor(Math.random() * 50 + 1220),
                    totalProcedures: Math.floor(Math.random() * 70 + 1650),
                    successRate: (Math.random() * 2 + 95.5).toFixed(1) + '%',
                    avgSatisfaction: (Math.random() * 0.3 + 4.6).toFixed(1)
                };

                Object.keys(updates).forEach(key => {
                    statisticsElements[key].textContent = updates[key];
                });
            }

            // Use requestAnimationFrame for more efficient updates
            function periodicUpdate() {
                updateStatistics();
                setTimeout(periodicUpdate, 30000);
            }

            // Start periodic updates
            periodicUpdate();
        });
    </script>
</body>
</html>